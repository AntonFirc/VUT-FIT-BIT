--------------------------------------------------------
--  File created - Saturday-March-31-2018
--------------------------------------------------------
DROP TABLE "CENA_FILMU" CASCADE CONSTRAINTS;
DROP TABLE "FILM" CASCADE CONSTRAINTS;
DROP TABLE "KINO" CASCADE CONSTRAINTS;
DROP TABLE "PROMITACI_SAL" CASCADE CONSTRAINTS;
DROP TABLE "PROMITACI_SALY_SEDADLA" CASCADE CONSTRAINTS;
DROP TABLE "PROMITACI_SAL_OBSAZENE_SEDADLO" CASCADE CONSTRAINTS;
DROP TABLE "PROMITACI_SAL_PROGRAM" CASCADE CONSTRAINTS;
DROP TABLE "UZIVATEL" CASCADE CONSTRAINTS;
--------------------------------------------------------
--  DDL for Table CENA_FILMU
--------------------------------------------------------

  CREATE TABLE "CENA_FILMU"
   (  "ID" NUMBER GENERATED BY DEFAULT AS IDENTITY INCREMENT BY 1 START WITH 1 NOMINVALUE NOMAXVALUE,
  "TYP_CLOVEKA" VARCHAR2(20 BYTE),
  "CENA" NUMBER,
  "FILM_ID" NUMBER
   ) SEGMENT CREATION IMMEDIATE
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;

--------------------------------------------------------
--  DDL for Table FILM
--------------------------------------------------------

  CREATE TABLE "FILM"
   (  "NAZEV" VARCHAR2(20 BYTE),
  "ZANR" VARCHAR2(20 BYTE),
  "POPIS" VARCHAR2(20 BYTE),
  "ID" NUMBER GENERATED BY DEFAULT AS IDENTITY INCREMENT BY 1 START WITH 1 NOMINVALUE NOMAXVALUE
   ) SEGMENT CREATION IMMEDIATE
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;

--------------------------------------------------------
--  DDL for Table KINO
--------------------------------------------------------

  CREATE TABLE "KINO"
   (  "LOKACE" VARCHAR2(100 BYTE),
  "ID" NUMBER GENERATED BY DEFAULT AS IDENTITY INCREMENT BY 1 START WITH 1 NOMINVALUE NOMAXVALUE
   ) SEGMENT CREATION IMMEDIATE
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;

--------------------------------------------------------
--  DDL for Table PROMITACI_SAL
--------------------------------------------------------

  CREATE TABLE "PROMITACI_SAL"
   (  "CISLO" NUMBER,
  "KINO_ID" NUMBER
   ) SEGMENT CREATION IMMEDIATE
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;

--------------------------------------------------------
--  DDL for Table PROMITACI_SALY_SEDADLA
--------------------------------------------------------

  CREATE TABLE "PROMITACI_SALY_SEDADLA"
   (  "ID" NUMBER GENERATED BY DEFAULT AS IDENTITY INCREMENT BY 1 START WITH 1 NOMINVALUE NOMAXVALUE,
  "CISLO_RADY" NUMBER,
  "CISLO_SEDADLA" NUMBER
   ) SEGMENT CREATION IMMEDIATE
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;

--------------------------------------------------------
--  DDL for Table PROMITACI_SAL_OBSAZENE_SEDADLO
--------------------------------------------------------

  CREATE TABLE "PROMITACI_SAL_OBSAZENE_SEDADLO"
   (  "ID" NUMBER GENERATED BY DEFAULT AS IDENTITY INCREMENT BY 1 START WITH 1 NOMINVALUE NOMAXVALUE,
  "REZERVOVANO" NUMBER,
  "PRODANO" NUMBER,
  "OBSADIL_UZIVATEL_ID" NUMBER,
  "SEDADLO_ID" NUMBER,
  "PROGRAM_ID" NUMBER
   ) SEGMENT CREATION IMMEDIATE
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;

--------------------------------------------------------
--  DDL for Table PROMITACI_SAL_PROGRAM
--------------------------------------------------------

  CREATE TABLE "PROMITACI_SAL_PROGRAM"
   (  "ID" NUMBER GENERATED BY DEFAULT AS IDENTITY INCREMENT BY 1 START WITH 1 NOMINVALUE NOMAXVALUE,
  "CAS" TIMESTAMP (6),
  "FILM_ID" NUMBER
   ) SEGMENT CREATION IMMEDIATE
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;

--------------------------------------------------------
--  DDL for Table UZIVATEL
--------------------------------------------------------

  CREATE TABLE "UZIVATEL"
   (  "ID" NUMBER GENERATED BY DEFAULT AS IDENTITY INCREMENT BY 1 START WITH 1 NOMINVALUE NOMAXVALUE,
  "JMENO" VARCHAR2(20 BYTE),
  "PRIJMENI" VARCHAR2(20 BYTE),
  "DATUM_NAROZENI" DATE,
  "VERNOSTNI_BODY" NUMBER,
  "ADRESA" VARCHAR2(20 BYTE),
  "PRACOVNI_POZICE" VARCHAR2(20 BYTE)
   ) SEGMENT CREATION IMMEDIATE
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;

-- Pristup pre 2 clena timu
GRANT ALL ON FILM TO xfolty15;
GRANT ALL ON PROMITACI_SAL_PROGRAM TO xfolty15;
GRANT ALL ON PROMITACI_SALY_SEDADLA TO xfolty15;
GRANT EXECUTE ON uzivatel_listky TO xfolty15;
GRANT EXECUTE ON film_listky TO xfolty15;

SET SERVEROUTPUT ON;

-------------------------------------------------------
--Triggery
-------------------------------------------------------
DROP SEQUENCE newID;
CREATE SEQUENCE newID;

CREATE OR REPLACE TRIGGER ai -- generuje ID pre kazdy film
  BEFORE INSERT ON FILM
  FOR EACH ROW
BEGIN
  :new.ID := newID.nextval;
END ai;
/

CREATE OR REPLACE TRIGGER adresa --kontrola tvaru adresy "Nazov ulice + cislo"
	BEFORE INSERT OR UPDATE OF "ADRESA" ON "UZIVATEL"
	FOR EACH ROW
DECLARE
    adresa"UZIVATEL"."ADRESA"%TYPE;
BEGIN
    adresa := :new.ADRESA;
    IF NOT REGEXP_LIKE (adresa, '^([a-zA-Z ]+) ([0-9\/]+)') THEN
            Raise_Application_Error (-20042, 'Nespravny format adresy !');
    END IF;
END adresa;
/

-- Procedura 1
-- Pre zadane ID filmu,vypise pocet predanych a rezervovanych listkov
CREATE OR REPLACE PROCEDURE film_listky(FILM_ID IN NUMBER)
IS
    CURSOR rezervovano IS SELECT F.NAZEV ,F.ID, PS.REZERVOVANO, PS.PRODANO FROM FILM F, PROMITACI_SAL_PROGRAM PP, PROMITACI_SAL_OBSAZENE_SEDADLO PS WHERE F.ID = PP.FILM_ID AND PP.ID = PS.PROGRAM_ID;
    rez_select rezervovano%ROWTYPE;
    rezervovano_l NUMBER;
    prodano NUMBER;
    nazev_filmu VARCHAR2(100);
BEGIN
    SELECT NAZEV INTO nazev_filmu FROM FILM WHERE FILM_ID = FILM.ID;
    rezervovano_l := 0;
    prodano := 0;

    OPEN rezervovano;
    LOOP
        FETCH rezervovano into rez_select;
        EXIT WHEN rezervovano%NOTFOUND;

        IF (FILM_ID = rez_select.ID) THEN
            IF (rez_select.REZERVOVANO = '1') THEN
                rezervovano_l := rezervovano_l + 1;
            END IF;
            IF (rez_select.PRODANO = '1') THEN
              prodano := prodano + 1;
            END IF;
        END IF;

    END LOOP;
    CLOSE rezervovano;

    dbms_output.put_line('FILM');
    dbms_output.put_line('ID   : ' || FILM_ID);
    dbms_output.put_line('Nazev: ' || nazev_filmu);
    IF (rezervovano_l = 0) THEN
        dbms_output.put_line('AKTUALNE NIE JE REZERVOVANY ZADNY LISTEK');
    ELSE
        dbms_output.put_line('Rezervovano : ' || rezervovano_l || ' listku');
    END IF;

    IF (prodano = 0) THEN
        dbms_output.put_line('AKTUALNE NIE JE PRODANY ZADNY LISTEK');
    ELSE
        dbms_output.put_line('Prodano     : ' || prodano || ' listku');
    END IF;

    EXCEPTION
    WHEN NO_DATA_FOUND THEN
        dbms_output.put_line('FILM s ID "' || FILM_ID || '" neexistuje!');
    WHEN OTHERS THEN
        Raise_Application_Error (-20420, 'PROCEDURE ERROR!');
END;
/
-- Procedura 2
-- Pre zadane ID uzivatela vypise vsetky filmy na ktore si kupil listok
CREATE OR REPLACE PROCEDURE uzivatel_listky(UZIVATEL_ID IN NUMBER)
IS
    CURSOR prodano IS SELECT DISTINCT F.NAZEV, U.ID, PS.PRODANO, U.JMENO, U.PRIJMENI FROM FILM F, PROMITACI_SAL_PROGRAM PP, PROMITACI_SAL_OBSAZENE_SEDADLO PS, UZIVATEL U WHERE F.ID = PP.FILM_ID AND PP.ID = PS.PROGRAM_ID AND PS.OBSADIL_UZIVATEL_ID = U.ID;
    usr_select prodano%ROWTYPE;
    jmeno VARCHAR2(10);
    prijmeni VARCHAR2(20);
BEGIN
    SELECT JMENO INTO jmeno FROM UZIVATEL WHERE UZIVATEL_ID = UZIVATEL.ID;
    SELECT PRIJMENI INTO prijmeni FROM UZIVATEL WHERE UZIVATEL_ID = UZIVATEL.ID;

    dbms_output.put_line('Uzivatel ' || jmeno || ' ' || prijmeni || ' zakoupil listky na film(y):');

    OPEN prodano;
    LOOP
        FETCH prodano into usr_select;
        EXIT WHEN prodano%NOTFOUND;

        IF (UZIVATEL_ID = usr_select.ID) THEN
            IF (usr_select.PRODANO = '1') THEN
              dbms_output.put_line(usr_select.NAZEV);
            END IF;
        END IF;

    END LOOP;
    CLOSE prodano;

    EXCEPTION
    WHEN NO_DATA_FOUND THEN
        dbms_output.put_line('UZIVATEL s ID "' || UZIVATEL_ID || '" neexistuje!');
    WHEN OTHERS THEN
        Raise_Application_Error (-20420, 'PROCEDURE ERROR!');
END;
/
-- Vzorove data
REM INSERTING into CENA_FILMU
SET DEFINE OFF;
Insert into CENA_FILMU (ID,TYP_CLOVEKA,CENA,FILM_ID) values ('1','dite','99','1');
Insert into CENA_FILMU (ID,TYP_CLOVEKA,CENA,FILM_ID) values ('2','dospely','109','1');
Insert into CENA_FILMU (ID,TYP_CLOVEKA,CENA,FILM_ID) values ('3','dite','89','2');
Insert into CENA_FILMU (ID,TYP_CLOVEKA,CENA,FILM_ID) values ('4','dospely','100','2');
Insert into CENA_FILMU (ID,TYP_CLOVEKA,CENA,FILM_ID) values ('5','dite','75','3');
Insert into CENA_FILMU (ID,TYP_CLOVEKA,CENA,FILM_ID) values ('6','dospely','92','3');
REM INSERTING into FILM
SET DEFINE OFF;
Insert into FILM (NAZEV,ZANR,POPIS,ID) values ('Black Hawk Down','valecny','Popisek filmu','1');
Insert into FILM (NAZEV,ZANR,POPIS,ID) values ('Rambo','valecny','Popisek filmu','2');
Insert into FILM (NAZEV,ZANR,POPIS,ID) values ('UP','animovany','Popisek filmu','3');
REM INSERTING into KINO
SET DEFINE OFF;
Insert into KINO (LOKACE,ID) values ('Hradec Králové','1');
Insert into KINO (LOKACE,ID) values ('Brno','2');
REM INSERTING into PROMITACI_SAL
SET DEFINE OFF;
Insert into PROMITACI_SAL (CISLO,KINO_ID) values ('1','1');
Insert into PROMITACI_SAL (CISLO,KINO_ID) values ('2','1');
Insert into PROMITACI_SAL (CISLO,KINO_ID) values ('3','1');
REM INSERTING into PROMITACI_SALY_SEDADLA
SET DEFINE OFF;
Insert into PROMITACI_SALY_SEDADLA (ID,CISLO_RADY,CISLO_SEDADLA) values ('1','1','1');
Insert into PROMITACI_SALY_SEDADLA (ID,CISLO_RADY,CISLO_SEDADLA) values ('2','1','2');
Insert into PROMITACI_SALY_SEDADLA (ID,CISLO_RADY,CISLO_SEDADLA) values ('3','2','1');
Insert into PROMITACI_SALY_SEDADLA (ID,CISLO_RADY,CISLO_SEDADLA) values ('4','2','2');
REM INSERTING into PROMITACI_SAL_OBSAZENE_SEDADLO
SET DEFINE OFF;
Insert into PROMITACI_SAL_OBSAZENE_SEDADLO (ID,REZERVOVANO,PRODANO,OBSADIL_UZIVATEL_ID,SEDADLO_ID,PROGRAM_ID) values ('1','1','0','1','1','1');
Insert into PROMITACI_SAL_OBSAZENE_SEDADLO (ID,REZERVOVANO,PRODANO,OBSADIL_UZIVATEL_ID,SEDADLO_ID,PROGRAM_ID) values ('2','1','1','2','2','1');
Insert into PROMITACI_SAL_OBSAZENE_SEDADLO (ID,REZERVOVANO,PRODANO,OBSADIL_UZIVATEL_ID,SEDADLO_ID,PROGRAM_ID) values ('3','1','1','3','3','2');
Insert into PROMITACI_SAL_OBSAZENE_SEDADLO (ID,REZERVOVANO,PRODANO,OBSADIL_UZIVATEL_ID,SEDADLO_ID,PROGRAM_ID) values ('4','1','1','2','4','2');
Insert into PROMITACI_SAL_OBSAZENE_SEDADLO (ID,REZERVOVANO,PRODANO,OBSADIL_UZIVATEL_ID,SEDADLO_ID,PROGRAM_ID) values ('5','1','0','1','5','2');
Insert into PROMITACI_SAL_OBSAZENE_SEDADLO (ID,REZERVOVANO,PRODANO,OBSADIL_UZIVATEL_ID,SEDADLO_ID,PROGRAM_ID) values ('6','1','1','2','6','3');
Insert into PROMITACI_SAL_OBSAZENE_SEDADLO (ID,REZERVOVANO,PRODANO,OBSADIL_UZIVATEL_ID,SEDADLO_ID,PROGRAM_ID) values ('7','1','1','1','7','3');
Insert into PROMITACI_SAL_OBSAZENE_SEDADLO (ID,REZERVOVANO,PRODANO,OBSADIL_UZIVATEL_ID,SEDADLO_ID,PROGRAM_ID) values ('8','1','1','2','8','3');
REM INSERTING into PROMITACI_SAL_PROGRAM
SET DEFINE OFF;
Insert into PROMITACI_SAL_PROGRAM (ID,CAS,FILM_ID) values ('1',to_timestamp('30.03.18 14:21:15,872000000','DD.MM.RR HH24:MI:SSXFF'),'1');
Insert into PROMITACI_SAL_PROGRAM (ID,CAS,FILM_ID) values ('2',to_timestamp('31.03.18 20:00:07,872000000','DD.MM.RR HH24:MI:SSXFF'),'2');
Insert into PROMITACI_SAL_PROGRAM (ID,CAS,FILM_ID) values ('3',to_timestamp('01.04.18 20:00:07,872000000','DD.MM.RR HH24:MI:SSXFF'),'2');
Insert into PROMITACI_SAL_PROGRAM (ID,CAS,FILM_ID) values ('4',to_timestamp('02.04.18 14:50:15,872000000','DD.MM.RR HH24:MI:SSXFF'),'3');
REM INSERTING into UZIVATEL
SET DEFINE OFF;
Insert into UZIVATEL (ID,JMENO,PRIJMENI,DATUM_NAROZENI,VERNOSTNI_BODY,ADRESA,PRACOVNI_POZICE) values ('1','Martin','Foltyn',to_date('01.04.96','DD.MM.RR'),'14','Orlicka 984','Pokladni');
Insert into UZIVATEL (ID,JMENO,PRIJMENI,DATUM_NAROZENI,VERNOSTNI_BODY,ADRESA,PRACOVNI_POZICE) values ('2','Anton','Firc',to_date('08.03.96','DD.MM.RR'),null,'Orlicka 983','Pokladni');
Insert into UZIVATEL (ID,JMENO,PRIJMENI,DATUM_NAROZENI,VERNOSTNI_BODY,ADRESA,PRACOVNI_POZICE) values ('3','Martin','Firc',to_date('08.03.96','DD.MM.RR'),'8','Kralovopolska 2369','Vedouci');
Insert into UZIVATEL (ID,JMENO,PRIJMENI,DATUM_NAROZENI,VERNOSTNI_BODY,ADRESA,PRACOVNI_POZICE) values ('4','Anton','Foltyn',to_date('08.03.96','DD.MM.RR'),'1','Majova 8',null);
Insert into UZIVATEL (ID,JMENO,PRIJMENI,DATUM_NAROZENI,VERNOSTNI_BODY,ADRESA,PRACOVNI_POZICE) values ('5','Chuck','Norris',to_date('08.03.96','DD.MM.RR'),'159','Bozetechova 2',null);
--------------------------------------------------------
--  DDL for Index CENA_FILMU_PK
--------------------------------------------------------

  CREATE UNIQUE INDEX "CENA_FILMU_PK" ON "CENA_FILMU" ("ID")
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;
--------------------------------------------------------
--  DDL for Index FILM_INDEX1
--------------------------------------------------------

  CREATE UNIQUE INDEX "FILM_INDEX1" ON "FILM" ("NAZEV")
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;
--------------------------------------------------------
--  DDL for Index FILM_PK
--------------------------------------------------------

  CREATE UNIQUE INDEX "FILM_PK" ON "FILM" ("ID")
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;
--------------------------------------------------------
--  DDL for Index KINO_PK
--------------------------------------------------------

  CREATE UNIQUE INDEX "KINO_PK" ON "KINO" ("LOKACE")
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;
--------------------------------------------------------
--  DDL for Index KINO_PK1
--------------------------------------------------------

  CREATE UNIQUE INDEX "KINO_PK1" ON "KINO" ("ID")
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;
--------------------------------------------------------
--  DDL for Index PROMITACI_SALY_SEDADLA_PK
--------------------------------------------------------

  CREATE UNIQUE INDEX "PROMITACI_SALY_SEDADLA_PK" ON "PROMITACI_SALY_SEDADLA" ("ID")
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;
--------------------------------------------------------
--  DDL for Index PROMITACI_SAL_OBSAZENE_SEDADLO_PK
--------------------------------------------------------

  CREATE UNIQUE INDEX "PROMITACI_SAL_OBSAZENE_SEDADLO_PK" ON "PROMITACI_SAL_OBSAZENE_SEDADLO" ("ID")
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;
--------------------------------------------------------
--  DDL for Index PROMITACI_SAL_PK
--------------------------------------------------------

  CREATE UNIQUE INDEX "PROMITACI_SAL_PK" ON "PROMITACI_SAL" ("CISLO")
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;
--------------------------------------------------------
--  DDL for Index PROMITACI_SAL_PROGRAM_PK
--------------------------------------------------------

  CREATE UNIQUE INDEX "PROMITACI_SAL_PROGRAM_PK" ON "PROMITACI_SAL_PROGRAM" ("ID")
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;
--------------------------------------------------------
--  DDL for Index UZIVATEL_PK
--------------------------------------------------------

  CREATE UNIQUE INDEX "UZIVATEL_PK" ON "UZIVATEL" ("ID")
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;
--------------------------------------------------------
--  Constraints for Table CENA_FILMU
--------------------------------------------------------

  ALTER TABLE "CENA_FILMU" ADD CONSTRAINT "CENA_FILMU_PK" PRIMARY KEY ("ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE;

--------------------------------------------------------
--  Constraints for Table FILM
--------------------------------------------------------

  ALTER TABLE "FILM" ADD CONSTRAINT "FILM_PK" PRIMARY KEY ("ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE;
  ALTER TABLE "FILM" MODIFY ("NAZEV" NOT NULL ENABLE);

--------------------------------------------------------
--  Constraints for Table KINO
--------------------------------------------------------

  ALTER TABLE "KINO" MODIFY ("LOKACE" NOT NULL ENABLE);
--------------------------------------------------------
--  Constraints for Table PROMITACI_SAL
--------------------------------------------------------

  ALTER TABLE "PROMITACI_SAL" ADD CONSTRAINT "PROMITACI_SAL_PK" PRIMARY KEY ("CISLO")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE;

  ALTER TABLE "PROMITACI_SAL" MODIFY ("KINO_ID" NOT NULL ENABLE);
--------------------------------------------------------
--  Constraints for Table PROMITACI_SALY_SEDADLA
--------------------------------------------------------

  ALTER TABLE "PROMITACI_SALY_SEDADLA" ADD CONSTRAINT "PROMITACI_SALY_SEDADLA_PK" PRIMARY KEY ("ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE;

--------------------------------------------------------
--  Constraints for Table PROMITACI_SAL_OBSAZENE_SEDADLO
--------------------------------------------------------

  ALTER TABLE "PROMITACI_SAL_OBSAZENE_SEDADLO" ADD CONSTRAINT "PROMITACI_SAL_OBSAZENE_SEDADLO_PK" PRIMARY KEY ("ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE;

  ALTER TABLE "PROMITACI_SAL_OBSAZENE_SEDADLO" MODIFY ("OBSADIL_UZIVATEL_ID" NOT NULL ENABLE);
  ALTER TABLE "PROMITACI_SAL_OBSAZENE_SEDADLO" MODIFY ("SEDADLO_ID" NOT NULL ENABLE);
  ALTER TABLE "PROMITACI_SAL_OBSAZENE_SEDADLO" MODIFY ("PROGRAM_ID" NOT NULL ENABLE);
  ALTER TABLE "PROMITACI_SAL_OBSAZENE_SEDADLO" MODIFY ("REZERVOVANO" NOT NULL ENABLE);
  ALTER TABLE "PROMITACI_SAL_OBSAZENE_SEDADLO" MODIFY ("PRODANO" NOT NULL ENABLE);
--------------------------------------------------------
--  Constraints for Table PROMITACI_SAL_PROGRAM
--------------------------------------------------------

  ALTER TABLE "PROMITACI_SAL_PROGRAM" ADD CONSTRAINT "PROMITACI_SAL_PROGRAM_PK" PRIMARY KEY ("ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE;

--------------------------------------------------------
--  Constraints for Table UZIVATEL
--------------------------------------------------------


  ALTER TABLE "UZIVATEL" MODIFY ("JMENO" NOT NULL ENABLE);
  ALTER TABLE "UZIVATEL" MODIFY ("PRIJMENI" NOT NULL ENABLE);
  ALTER TABLE "UZIVATEL" ADD CONSTRAINT "UZIVATEL_PK" PRIMARY KEY ("ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE;
  ALTER TABLE "UZIVATEL" ADD CONSTRAINT "klient-zamestnanec" CHECK (("ADRESA" IS NOT NULL AND "PRACOVNI_POZICE" IS NOT NULL) OR ("VERNOSTNI_BODY" IS NOT NULL)) ENABLE;
--------------------------------------------------------
--  Ref Constraints for Table CENA_FILMU
--------------------------------------------------------

  ALTER TABLE "CENA_FILMU" ADD CONSTRAINT "FILM_ID_PK" FOREIGN KEY ("FILM_ID")
    REFERENCES "FILM" ("ID") ON DELETE CASCADE ENABLE;
--------------------------------------------------------
--  Ref Constraints for Table PROMITACI_SAL_OBSAZENE_SEDADLO
--------------------------------------------------------

  ALTER TABLE "PROMITACI_SAL_OBSAZENE_SEDADLO" ADD CONSTRAINT "OBSAZENO_UZIVATELEM" FOREIGN KEY ("OBSADIL_UZIVATEL_ID")
    REFERENCES "UZIVATEL" ("ID") ON DELETE CASCADE ENABLE;
  ALTER TABLE "PROMITACI_SAL_OBSAZENE_SEDADLO" ADD CONSTRAINT "PROGRAM_ID" FOREIGN KEY ("PROGRAM_ID")
    REFERENCES "PROMITACI_SAL_PROGRAM" ("ID") ON DELETE CASCADE ENABLE;
  ALTER TABLE "PROMITACI_SAL_OBSAZENE_SEDADLO" ADD CONSTRAINT "SEDADLO_ID" FOREIGN KEY ("SEDADLO_ID")
    REFERENCES "PROMITACI_SALY_SEDADLA" ("ID") ON DELETE CASCADE ENABLE;
--------------------------------------------------------
--  Ref Constraints for Table PROMITACI_SAL_PROGRAM
--------------------------------------------------------

  ALTER TABLE "PROMITACI_SAL_PROGRAM" ADD CONSTRAINT "FILM_ID" FOREIGN KEY ("FILM_ID")
    REFERENCES "FILM" ("ID") ON DELETE CASCADE ENABLE;

--Vypis nazvu a ceny filmu kde je zanr "valecny" a cena pre dospeleho cloveka
SELECT F.NAZEV, C.CENA
FROM FILM F, CENA_FILMU C
WHERE F.ZANR = 'valecny' and C.TYP_CLOVEKA='dospely' and F.ID = C.FILM_ID;
--Vypis vsetkych nazvov filmu a casov kedy sa premieta
SELECT F.NAZEV, P.CAS
FROM FILM F, PROMITACI_SAL_PROGRAM P
WHERE P.FILM_ID = F.ID;

--Vypis casu a ID sedadla na ktore ma uzivatel Anton Firc obsadene
SELECT P.CAS, So.SEDADLO_ID
FROM PROMITACI_SAL_OBSAZENE_SEDADLO So, UZIVATEL U, PROMITACI_SAL_PROGRAM P
WHERE U.JMENO='Anton' and U.PRIJMENI='Firc' and U.ID = So.OBSADIL_UZIVATEL_ID and So.PROGRAM_ID = P.ID;

--Pre kazdy praconu poziciu vypise pocet zamestnancov
SELECT U.PRACOVNI_POZICE, count(U.PRACOVNI_POZICE)
FROM UZIVATEL U
GROUP BY U.PRACOVNI_POZICE;
--Pre kazdy zanr vypise najnizsiu moznu cenu listka
SELECT F.ZANR, min(C.CENA)
FROM FILM F, CENA_FILMU C
WHERE F.ID = C.FILM_ID
GROUP BY F.ZANR;

--Zisti mena a priezviska uzivatelov ktory maju rezervovane sedadlo
SELECT U.JMENO, U.PRIJMENI
FROM UZIVATEL U
WHERE EXISTS
(
  SELECT Os.OBSADIL_UZIVATEL_ID
  FROM PROMITACI_SAL_OBSAZENE_SEDADLO Os
  WHERE U.ID = Os.OBSADIL_UZIVATEL_ID and Os.REZERVOVANO='1'
);


--Najde nazvy filmov a premietacie casy kde je cena dospeleho listka 90-100
SELECT F.NAZEV, P.CAS
FROM FILM F, PROMITACI_SAL_PROGRAM P
WHERE F.ID = P.FILM_ID and F.ID
IN
(
  SELECT C.FILM_ID
  FROM CENA_FILMU C
  WHERE C.CENA BETWEEN '90' and '100' and C.TYP_CLOVEKA='dospely'
);

--materializovany pohlad
DROP MATERIALIZED VIEW cena;
CREATE MATERIALIZED VIEW LOG ON CENA_FILMU WITH PRIMARY KEY, ROWID;

CREATE MATERIALIZED VIEW cena
CACHE
BUILD IMMEDIATE
REFRESH FAST ON COMMIT
ENABLE QUERY REWRITE
AS SELECT * FROM CENA_FILMU;

GRANT ALL ON CENA_FILMU TO xfolty15;

SELECT * FROM CENA_FILMU;
Insert into CENA_FILMU (ID,TYP_CLOVEKA,CENA,FILM_ID) values ('7','ztp','19','1');
COMMIT;
SELECT * FROM CENA_FILMU;

--Explain Plan pre select dotaz a select dotaz s indexom
EXPLAIN PLAN FOR
SELECT F.ZANR, min(C.CENA)
FROM FILM F, CENA_FILMU C
WHERE F.ID = C.FILM_ID
GROUP BY F.ZANR;
SELECT * FROM TABLE (dbms_xplan.display());

CREATE INDEX ex_idx ON "CENA_FILMU"("FILM_ID");

EXPLAIN PLAN FOR
SELECT F.ZANR, min(C.CENA)
FROM FILM F, CENA_FILMU C
WHERE /*+ INDEX(C ex_idx)*/ "FILM_ID" = F.ID
GROUP BY F.ZANR;
SELECT * FROM TABLE (dbms_xplan.display());

-- Volanie procedur
exec film_listky('1');
exec uzivatel_listky('2');
